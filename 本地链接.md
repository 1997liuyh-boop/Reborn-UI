## 本地链接（reborn-ui）

重要：**不要混用包管理器**。测试项目如果是 pnpm 安装（`node_modules/.pnpm/` 或存在 `pnpm-lock.yaml`），就用 pnpm 的 link 流程；如果测试项目是 npm 安装（`package-lock.json`），就用 npm 的 link 流程。

### 流程 A（推荐给 pnpm 项目）：用 `link:` 直接引用本地目录（最稳）

优点：不依赖 pnpm 的 global 目录/Path，不会遇到 `ERR_PNPM_NO_GLOBAL_BIN_DIR` / `Symlink path is the same as the target path`。

在测试项目（`fast-vue3`）目录：
```powershell
cd D:\demo\fast-vue3
pnpm add -D reborn-ui@link:../shadcn-docs-nuxt-starter/packages/cli
pnpm i
pnpm exec reborn-ui init
pnpm exec reborn-ui add aurora-background
```

说明：`init` 过程中会询问 `aliasSymbol`（基于项目根目录映射的符号，默认 `@`）。
后续 `add`/模板写入会把文件中的 `@/` 前缀按需替换为你选择的符号（只替换符号，不改其它路径内容）。

解除：
```powershell
pnpm remove reborn-ui
```

（可选）如果你坚持要全局可执行命令，再用 global link，但 Windows 上容易踩环境变量/全局目录坑：见下方“pnpm 全局 link 常见报错”。

### npm link

1) 在发布仓库（本仓库 `packages/cli`）：
```powershell
cd D:\demo\shadcn-docs-nuxt-starter\packages\cli
npm link
```

2) 在测试项目：
```powershell
npm link reborn-ui --legacy-peer-deps
npx reborn-ui init
npx reborn-ui add aurora-background
```

3) 解除：
```powershell
npm unlink reborn-ui
```

## 常见问题：npm link 报 ERESOLVE（@typescript-eslint 版本冲突）

现象（典型日志片段）：
- `ERESOLVE could not resolve`
- `Found: @typescript-eslint/eslint-plugin@8.26.0 from typescript-eslint@8.26.0`
- `dev @typescript-eslint/eslint-plugin@"^8.46.4" from the root project`

原因：测试项目里同时存在 `typescript-eslint`（聚合包）和 `@typescript-eslint/*`（独立包），且版本不一致；npm v7+ 会严格校验 peer 依赖，直接失败。

推荐修复（选其一，保持同一版本）：

### 方案 A（推荐）：只用 `typescript-eslint` 聚合包
在测试项目执行：
```powershell
# npm：
npm remove @typescript-eslint/eslint-plugin @typescript-eslint/parser
npm i -D typescript-eslint@^8.50.1

# pnpm：
# pnpm remove @typescript-eslint/eslint-plugin @typescript-eslint/parser
# pnpm i -D typescript-eslint@^8.50.1
```
然后删除并重装（按你使用的包管理器二选一）：
```powershell
# npm：
rm -r -force node_modules,package-lock.json
npm i

# pnpm：
# rm -r -force node_modules,pnpm-lock.yaml
# pnpm i
```

### 方案 B：只用独立包（不装 `typescript-eslint`）
```powershell
# npm：
npm remove typescript-eslint
npm i -D @typescript-eslint/eslint-plugin@8.50.1 @typescript-eslint/parser@8.50.1
rm -r -force node_modules,package-lock.json
npm i

# pnpm：
# pnpm remove typescript-eslint
# pnpm i -D @typescript-eslint/eslint-plugin@8.50.1 @typescript-eslint/parser@8.50.1
# rm -r -force node_modules,pnpm-lock.yaml
# pnpm i
```

临时绕过（不推荐长期用）：
```powershell
npm link reborn-ui --legacy-peer-deps
```

## 常见问题：npm link 报 ERESOLVE（eslint-plugin-vue / vue-eslint-parser 版本冲突）

现象（典型日志片段）：
- `Found: eslint-plugin-vue@9.x`
- `dev eslint-plugin-vue@"^10.5.1" from the root project`
- `Conflicting peer dependency: vue-eslint-parser@10.x`

原因：测试项目里安装了 `eslint-plugin-vue@9.x`，但你的项目配置（或依赖链）要求 `eslint-plugin-vue@10.x`；同时 `eslint-plugin-vue@10.x` 需要 `vue-eslint-parser@^10` 配套。

推荐修复：统一到 `eslint-plugin-vue@10.x` + `vue-eslint-parser@10.x`
```powershell
# npm：
npm remove eslint-plugin-vue vue-eslint-parser
npm i -D eslint-plugin-vue@^10.6.2 vue-eslint-parser@^10.2.0
rm -r -force node_modules,package-lock.json
npm i

# pnpm：
# pnpm remove eslint-plugin-vue vue-eslint-parser
# pnpm i -D eslint-plugin-vue@^10.6.2 vue-eslint-parser@^10.2.0
# rm -r -force node_modules,pnpm-lock.yaml
# pnpm i
```

## 常见问题：npm link 直接崩溃（Cannot read properties of null (reading 'matches')）

现象：
- `npm error Cannot read properties of null (reading 'matches')`
- debug log 里堆栈通常指向 `@npmcli/arborist` 的 `Link.matches(...)`

高概率原因：测试项目的 `node_modules` 是 pnpm 的 `.pnpm/` 结构（或项目同时存在 `pnpm-lock.yaml` / `yarn.lock`），但你在执行 `npm link`，也就是 **混用包管理器**；npm 在 dedupe/link 的分支上可能触发内部 bug（npm@10.x + arborist）。

修复方式（选其一）：

### 方案 A（推荐）：全程用 pnpm（和现有 `.pnpm/` 结构保持一致）
在 `reborn-ui`（本仓库 `packages/cli`）目录：
```powershell
pnpm setup
pnpm link --global
```
在测试项目目录：
```powershell
pnpm link --global reborn-ui
pnpm i
```

## pnpm 全局 link 常见报错

如果报 `ERR_PNPM_NO_GLOBAL_BIN_DIR`：
- 确认你**重启了 Cursor/终端**（集成终端需要 Cursor 进程重启才会加载新的用户环境变量）。
- 或者临时在当前会话手动注入：
```powershell
$env:PNPM_HOME = "$env:LOCALAPPDATA\pnpm"
$env:Path = "$env:PNPM_HOME;$env:Path"
pnpm config set global-bin-dir $env:PNPM_HOME
pnpm config get global-bin-dir
```

如果报 `The configured global bin directory "...\\pnpm" is not in PATH`：
- 这是 **PATH 没包含 global bin dir**（常见于只“重启终端”但没重启 Cursor，或环境变量写入后当前会话未刷新）。
- 先在当前 PowerShell 让它立即生效，再重试 link：
```powershell
$env:PNPM_HOME = "$env:LOCALAPPDATA\pnpm"
$env:Path = "$env:PNPM_HOME;$env:Path"
pnpm link --global reborn-ui
```
- 想永久生效：把 `PNPM_HOME` 加入“用户 Path”，然后**重启 Cursor** 再试。

## 常见问题：Windows 下 EPERM（pnpm rename 到 node_modules/.ignored 失败）

现象（典型日志）：
- `WARN Moving <pkg> that was installed by a different package manager to "node_modules/.ignored"`
- `EPERM: operation not permitted, rename '...\\node_modules\\@xxx\\yyy' -> '...\\node_modules\\.ignored\\@xxx\\yyy'`

原因：项目的 `node_modules` 是被 **npm/yarn** 装出来的，但命令（通常是 `reborn-ui init`）又在项目里调用了 **pnpm** 去安装依赖；pnpm 会尝试把“其他包管理器安装的包”搬到 `node_modules/.ignored`，Windows 上如果文件被占用（IDE/终端/杀软/正在运行的 dev server）就会 `EPERM`。

推荐修复（本质：只用一种包管理器 + 清理干净）：

### 方案 A：项目用 pnpm（推荐）
在测试项目目录执行：
```powershell
# 1) 关闭所有占用 node_modules 的进程（dev server / 终端 / IDE 的 TS Server 等）
# 2) 清理旧的 node_modules 与遗留目录
rm -r -force node_modules
rm -r -force node_modules/.ignored -ErrorAction SilentlyContinue
rm -r -force package-lock.json -ErrorAction SilentlyContinue
rm -r -force yarn.lock -ErrorAction SilentlyContinue

# 3) 重新安装（只用 pnpm）
pnpm i
```
然后再运行：
```powershell
pnpm exec reborn-ui init
```

### 方案 B：项目用 npm（不推荐与 pnpm 混用）
如果你坚持用 npm，则请删除 `pnpm-lock.yaml`（以及任何 pnpm/yarn 的痕迹），并确保 `reborn-ui init` 走 npm 安装：
```powershell
rm -r -force node_modules,pnpm-lock.yaml,yarn.lock
npm i
```
然后再运行：
```powershell
npx reborn-ui init
```

## 常见问题：add 报 ENOENT（找不到 packages/registry/registry.json）

现象：
- `Error: ENOENT: no such file or directory, open '...\\packages\\registry\\registry.json'`

原因：CLI 的旧版本在打包成单文件后，builtin registry 的相对路径基准发生变化，误解析到了不存在的路径。

修复：
- 如果你是本仓库本地开发：在 `D:\demo\shadcn-docs-nuxt-starter\packages\cli` 重新构建一次：
```powershell
pnpm run build
```
- 然后在测试项目重试：
```powershell
pnpm exec reborn-ui add aurora-background
```

### 方案 B：把测试项目切回纯 npm 再用 npm link
在测试项目目录：
```powershell
rm -r -force node_modules,pnpm-lock.yaml,yarn.lock
npm i
npm link reborn-ui
```

补充：如果必须继续用 npm，也可以尝试升级 npm（有时可绕过 arborist bug）：
```powershell
npm i -g npm@latest
```